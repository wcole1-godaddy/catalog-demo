{
 "Description": "This stack includes resources needed to deploy AWS CDK apps into this environment",
 "Parameters": {
  "TrustedAccounts": {
   "Type": "CommaDelimitedList",
   "Default": "",
   "Description": "List of AWS accounts that are trusted to publish assets and deploy stacks to this environment"
  },
  "TrustedAccountsForLookup": {
   "Type": "CommaDelimitedList",
   "Default": "",
   "Description": "List of AWS accounts that are trusted to look up values in this environment"
  },
  "CloudFormationExecutionPolicies": {
   "Type": "CommaDelimitedList",
   "Default": "",
   "Description": "List of the ManagedPolicy ARN(s) to attach to the CloudFormation deployment role"
  },
  "FileAssetsBucketName": {
   "Type": "String",
   "Default": "",
   "Description": "The name of the S3 bucket used for file assets"
  },
  "FileAssetsBucketKmsKeyId": {
   "Type": "String",
   "Default": "",
   "Description": "Empty to create a new key (default), 'AWS_MANAGED_KEY' to use a managed S3 key, or the ID/ARN of an existing key."
  },
  "ContainerAssetsRepositoryName": {
   "Type": "String",
   "Default": "",
   "Description": "A user-provided custom name to use for the container assets ECR repository"
  },
  "Qualifier": {
   "Type": "String",
   "Default": "hnb659fds",
   "AllowedPattern": "[A-Za-z0-9_-]{1,10}",
   "ConstraintDescription": "Qualifier must be an alphanumeric identifier of at most 10 characters",
   "Description": "An identifier to distinguish multiple bootstrap stacks in the same environment"
  },
  "PublicAccessBlockConfiguration": {
   "Type": "String",
   "Default": "true",
   "AllowedValues": [
    "true",
    "false"
   ],
   "Description": "Whether or not to enable S3 Staging Bucket Public Access Block Configuration"
  }
 },
 "Conditions": {
  "HasTrustedAccounts": {
   "Fn::Not": [
    {
     "Fn::Equals": [
      "",
      {
       "Fn::Join": [
        "",
        {
         "Ref": "TrustedAccounts"
        }
       ]
      }
     ]
    }
   ]
  },
  "HasTrustedAccountsForLookup": {
   "Fn::Not": [
    {
     "Fn::Equals": [
      "",
      {
       "Fn::Join": [
        "",
        {
         "Ref": "TrustedAccountsForLookup"
        }
       ]
      }
     ]
    }
   ]
  },
  "HasCloudFormationExecutionPolicies": {
   "Fn::Not": [
    {
     "Fn::Equals": [
      "",
      {
       "Fn::Join": [
        "",
        {
         "Ref": "CloudFormationExecutionPolicies"
        }
       ]
      }
     ]
    }
   ]
  },
  "HasCustomFileAssetsBucketName": {
   "Fn::Not": [
    {
     "Fn::Equals": [
      "",
      {
       "Ref": "FileAssetsBucketName"
      }
     ]
    }
   ]
  },
  "CreateNewKey": {
   "Fn::Equals": [
    "",
    {
     "Ref": "FileAssetsBucketKmsKeyId"
    }
   ]
  },
  "UseAwsManagedKey": {
   "Fn::Equals": [
    "AWS_MANAGED_KEY",
    {
     "Ref": "FileAssetsBucketKmsKeyId"
    }
   ]
  },
  "HasCustomContainerAssetsRepositoryName": {
   "Fn::Not": [
    {
     "Fn::Equals": [
      "",
      {
       "Ref": "ContainerAssetsRepositoryName"
      }
     ]
    }
   ]
  },
  "UsePublicAccessBlockConfiguration": {
   "Fn::Equals": [
    "true",
    {
     "Ref": "PublicAccessBlockConfiguration"
    }
   ]
  }
 },
 "Resources": {
  "StagingBucket": {
   "Type": "AWS::S3::Bucket",
   "Properties": {
    "AccessControl": "Private",
    "BucketEncryption": {
     "ServerSideEncryptionConfiguration": [
      {
       "BucketKeyEnabled": false,
       "ServerSideEncryptionByDefault": {
        "KMSMasterKeyID": "arn:aws:kms:us-east-1:035935310217:key/4df20c54-288d-4c6f-ac67-7a11eb4932ca",
        "SSEAlgorithm": "aws:kms"
       }
      }
     ]
    },
    "BucketName": {
     "Fn::Join": [
      "",
      [
       "cdk-",
       {
        "Ref": "Qualifier"
       },
       "-assets-",
       {
        "Ref": "AWS::AccountId"
       },
       "-",
       {
        "Ref": "AWS::Region"
       }
      ]
     ]
    },
    "LoggingConfiguration": {
     "DestinationBucketName": "gd-access-commerceut-prod-logs-us-east-1-l14stq3nf",
     "LogFilePrefix": {
      "Fn::Join": [
       "",
       [
        "s3/cdk-",
        {
         "Ref": "Qualifier"
        },
        "-assets-",
        {
         "Ref": "AWS::AccountId"
        },
        "-",
        {
         "Ref": "AWS::Region"
        }
       ]
      ]
     }
    },
    "PublicAccessBlockConfiguration": {
     "Fn::If": [
      "UsePublicAccessBlockConfiguration",
      {
       "BlockPublicAcls": true,
       "BlockPublicPolicy": true,
       "IgnorePublicAcls": true,
       "RestrictPublicBuckets": true
      },
      {
       "Ref": "AWS::NoValue"
      }
     ]
    },
    "Tags": [
     {
      "Key": "BudgetId",
      "Value": "001297-07"
     },
     {
      "Key": "Env",
      "Value": "prod"
     },
     {
      "Key": "LegalOU",
      "Value": "USA"
     },
     {
      "Key": "OrgOU",
      "Value": "GD"
     },
     {
      "Key": "Team",
      "Value": "commerceut"
     }
    ],
    "VersioningConfiguration": {
     "Status": "Enabled"
    }
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain"
  },
  "StagingBucketPolicy": {
   "Type": "AWS::S3::BucketPolicy",
   "Properties": {
    "Bucket": {
     "Ref": "StagingBucket"
    },
    "PolicyDocument": {
     "Id": "AccessControl",
     "Version": "2012-10-17",
     "Statement": [
      {
       "Sid": "AllowSSLRequestsOnly",
       "Action": "s3:*",
       "Effect": "Deny",
       "Resource": [
        {
         "Fn::Sub": "${StagingBucket.Arn}"
        },
        {
         "Fn::Sub": "${StagingBucket.Arn}/*"
        }
       ],
       "Condition": {
        "Bool": {
         "aws:SecureTransport": "false"
        }
       },
       "Principal": "*"
      }
     ]
    }
   }
  },
  "ContainerAssetsRepository": {
   "Type": "AWS::ECR::Repository",
   "Properties": {
    "EncryptionConfiguration": {
     "EncryptionType": "KMS",
     "KmsKey": "arn:aws:kms:us-east-1:035935310217:alias/commerceut"
    },
    "ImageScanningConfiguration": {
     "ScanOnPush": true
    },
    "RepositoryName": {
     "Fn::If": [
      "HasCustomContainerAssetsRepositoryName",
      {
       "Fn::Sub": "${ContainerAssetsRepositoryName}"
      },
      {
       "Fn::Sub": "cdk-${Qualifier}-container-assets-${AWS::AccountId}-${AWS::Region}"
      }
     ]
    },
    "RepositoryPolicyText": {
     "Version": "2012-10-17",
     "Statement": [
      {
       "Sid": "LambdaECRImageRetrievalPolicy",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       },
       "Action": [
        "ecr:BatchGetImage",
        "ecr:GetDownloadUrlForLayer"
       ],
       "Condition": {
        "StringLike": {
         "aws:sourceArn": {
          "Fn::Sub": "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
         }
        }
       }
      }
     ]
    },
    "Tags": [
     {
      "Key": "BudgetId",
      "Value": "001297-07"
     },
     {
      "Key": "Env",
      "Value": "prod"
     },
     {
      "Key": "LegalOU",
      "Value": "USA"
     },
     {
      "Key": "OrgOU",
      "Value": "GD"
     },
     {
      "Key": "Team",
      "Value": "commerceut"
     }
    ]
   }
  },
  "CdkBootstrapVersion": {
   "Type": "AWS::SSM::Parameter",
   "Properties": {
    "Name": {
     "Fn::Sub": "/cdk-bootstrap/${Qualifier}/version"
    },
    "Tags": {
     "BudgetId": "001297-07",
     "Env": "prod",
     "LegalOU": "USA",
     "OrgOU": "GD",
     "Team": "commerceut"
    },
    "Type": "String",
    "Value": "12"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/02OywrCMBBFv8V9OmoF0a1dubL0B0pMpjBtmil5KKX0300siKs5M8w93BKuJRx28u0LpYfC0BMWZTjqjt0oA7FtySoTNULV2fuGImEtnRwxoMtLxVZTfhZJ1C7+BEu63qIaMIgf1WxIzatA5bKswYk9BXaz8H6Ef+eaQ48YpviNN+g5OoWrsJyK9H7/Ol7geE7Fe09UuGgDjQjNNj9kYGI51AAAAA=="
   },
   "Metadata": {
    "aws:cdk:path": "BootstrapStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "BucketName": {
   "Description": "The name of the S3 bucket owned by the CDK toolkit stack",
   "Value": {
    "Fn::Sub": "${StagingBucket}"
   }
  },
  "BucketDomainName": {
   "Description": "The domain name of the S3 bucket owned by the CDK toolkit stack",
   "Value": {
    "Fn::Sub": "${StagingBucket.RegionalDomainName}"
   }
  },
  "FileAssetKeyArn": {
   "Description": "The ARN of the KMS key used to encrypt the asset bucket (deprecated)",
   "Value": "arn:aws:kms:us-east-1:035935310217:key/4df20c54-288d-4c6f-ac67-7a11eb4932ca",
   "Export": {
    "Name": {
     "Fn::Sub": "CdkBootstrap-${Qualifier}-FileAssetKeyArn"
    }
   }
  },
  "ImageRepositoryName": {
   "Description": "The name of the ECR repository which hosts docker image assets",
   "Value": {
    "Fn::Sub": "${ContainerAssetsRepository}"
   }
  },
  "BootstrapVersion": {
   "Description": "The version of the bootstrap resources that are currently mastered in this stack",
   "Value": {
    "Fn::GetAtt": [
     "CdkBootstrapVersion",
     "Value"
    ]
   }
  }
 }
}